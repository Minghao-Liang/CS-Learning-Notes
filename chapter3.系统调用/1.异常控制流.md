# 异常控制流

## 控制流

程序的控制流是指以一个程序的指令、语句或基本块为单位的执行序列；处理器的控制流是指程序计数器中的控制转移序列。最简单的控制流是平滑的，而诸如跳转、调用和返回则会造成平滑流的突变。如果程序在执行过程中出现了系统调用请求、外设中断、CPU异常等情况，就会出现控制流的突变，我们把这种突变称为异常控制流。

## 异常

异常是异常控制流的一种形式，按照CSAPP，异常可以分为以下四类：

- 中断
- 陷阱
- 故障
- 终止

我们只是从操作系统的角度来进行讨论。然而关于这些异常，并没有一个唯一的精确解释。

在不同的书籍中，对于中断 、陷阱和异常的定义会有一些差别。有的书籍把中断、陷阱和异常都统一为一种中断，表示程序的当前控制流被打断了，要去执行不属于这个控制流的另外一个没有程序逻辑先后关系的控制流；也有书籍把这三者统一为一种异常，表示相对于程序的正常控制流而言，出现了的一种没有程序逻辑先后关系的异常控制流。甚至也有书籍把这三者统一为一种陷阱，表示相对于程序的正常控制流而言，CPU会陷入到操作系统内核中去执行。

在 RISC-V 的特权级规范文档中，异常指的是由于 CPU 当前指令执行而产生的异常控制流，中断指的是与 CPU 当前指令执行无关的异常控制流，中断和异常统称为陷阱。

在这里，因为我们使用RISC-V，所以我们以陷阱作为通用术语。陷阱，或者称为陷入（Trap）。

对于系统调用，有下图所示的执行机制，中断和异常同理。

![syscall.png](https://s2.loli.net/2022/05/15/mAyjXrNsEw6pn4o.png)